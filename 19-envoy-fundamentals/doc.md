## What is Envoy?

行业正在向微服务架构和云原生解决方案发展。使用不同技术开发的微服务成百上千，这些系统可能会变得复杂且难以调试。

作为应用程序开发人员，您会考虑业务逻辑--购买产品或生成发票。然而，任何类似的业务逻辑都会导致不同服务之间的多次服务调用。每个服务可能都有其超时、重试逻辑和其他特定于网络的代码，这些都可能需要调整或微调。

如果初始请求在任何时候出现故障，就很难通过多个服务进行跟踪，确定故障发生的位置，并了解故障原因。是网络不可靠吗？我们是否需要调整重试或超时？还是业务逻辑问题或错误？

服务可能使用不一致的跟踪和日志记录机制，这增加了调试的复杂性。这些问题导致很难确定问题所在、发生地点以及如何修复。如果您是应用程序开发人员，而调试网络问题又不属于您的核心技能范围，那么情况就更是如此。

要想更轻松地调试这些网络问题，就必须将网络问题从应用堆栈中分离出来，让另一个组件来处理网络部分。这正是 Envoy 可以做到的。

在其中一种部署模式中，我们在每个服务实例旁边都运行一个 Envoy 实例。这种部署方式也称为**sidecar deployment**，Envoy 的另一种部署模式是边缘代理（**edge-proxy**），用于构建 API 网关。

Envoy 和应用程序构成一个原子实体，但仍然是独立的进程。应用程序处理业务逻辑，Envoy 处理网络问题。

在出现故障时，将关注点分开可以更容易地确定故障是来自应用程序还是网络。

为帮助进行网络调试，Envoy 提供了以下高级功能：

### Out-of-process architecture

envoy 是一个自足的进程，旨在与每个应用程序一起运行--这就是我们前面提到的sidecar deployment。集中配置的 Envoy 集合形成了一个透明的网状结构。

路由选择和其他网络功能的责任被推给 Envoy。应用程序将请求发送到虚拟地址（localhost）而不是真实地址（如公共 IP 地址或主机名），而不会注意到网络拓扑结构。应用程序不再承担路由选择的责任，因为这项任务被委托给了外部进程。

在企业中，这可以让应用程序开发人员专注于应用程序的业务逻辑，而不是让应用程序管理其网络配置。

Envoy 支持任何编程语言。你可以用 Go、Java、C++ 或任何其他语言编写应用程序，而 Envoy 可以在它们之间架起一座桥梁。无论应用程序使用哪种编程语言或在哪种操作系统上运行，Envoy 的行为都是相同的。

Envoy 还可以在整个基础架构中透明地部署和升级。相比之下，为每个单独的应用程序部署库升级可能会非常痛苦和耗时。

进程外架构的好处在于，它能让我们在编程语言/应用程序栈之间保持一致，而且我们还能获得独立的生命周期和所有免费的 Envoy 网络功能，而无需在每个应用程序中单独解决这些问题。

### L3/L4 filter architecture

Envoy 是一款 L3/L4 网络代理，可根据 IP 地址和 TCP 或 UDP 端口做出决定。它具有可插拔的过滤器链，可编写过滤器来执行不同的 TCP/UDP 任务。

过滤链(**filter chain**)源于 shell 的一个想法，即把一个操作的输出通过管道输送到另一个操作中。例如

```shell
ls -l | grep "Envoy*.cc" | wc -l
```

Envoy 可以通过堆叠所需的过滤器来构建逻辑和行为，从而形成一个过滤器链。现有的许多过滤器都支持原始 TCP 代理、UDP 代理、HTTP 代理、TLS 客户端认证等任务。Envoy 还具有可扩展性，我们可以编写自己的过滤器。

### L7 filter architecture

Envoy 支持额外的 HTTP L7 过滤层。我们可以在 HTTP 连接管理子系统（**HTTP connection management subsystem**）中插入 HTTP 过滤器，执行缓冲、速率限制、路由/转发等不同任务。

### First-class HTTP/2 support

Envoy 同时支持 HTTP/1.1 和 HTTP/2，可作为 HTTP/1.1 到 HTTP/2 的透明代理双向运行。这意味着可以桥接 HTTP/1.1 和 HTTP/2 客户端与目标服务器的任何组合。即使你的传统应用程序不是通过 HTTP/2 通信，如果你将它们与 Envoy 代理一起部署，它们最终也会通过 HTTP/2 通信。

推荐的service-to-service配置在所有envoys之间使用 HTTP/2，以创建一个可复用请求和响应的持久连接网状结构。

### HTTP routing

在 HTTP 模式下运行并使用 REST 时，Envoy 支持路由子系统，能够根据路径、权限、内容类型和运行时值对请求进行路由和重定向。将 Envoy 用作构建 API 网关的前端/边缘代理(**front/edge proxy**)时，以及构建服务网格（**sidecar deployment pattern**）时，该功能都非常有用。

### gRPC ready

Envoy 支持作为 gRPC 请求和响应的路由和balancing substrate所需的所有 HTTP/2 功能。

+ HTTP/2 是 gRPC 的底层协议，提供多路复用、长连接等能力。

+ Envoy 完全支持 HTTP/2，因此可以很好地代理和负载均衡 gRPC 请求。

+ Envoy 让 gRPC 服务更加稳定、高效，可以均衡流量，并优化 HTTP/2 连接。

<blockquote style="border-left: 3px solid #673AB7; padding-left: 10px; color: #673AB7; font-size: 16px;">
gRPC 是一种开源远程过程调用（RPC）系统，使用 HTTP/2 作为传输方式，使用协议缓冲区作为接口描述语言（IDL），并提供身份验证、双向流和流量控制、阻塞/非阻塞绑定、取消和超时等功能。
</blockquote>

### Service discovery and dynamic configuration

我们可以使用静态配置文件来配置 Envoy，这些文件描述了服务以及如何与它们通信。

Envoy 支持动态配置，并可在运行时自动重新加载配置。一组名为 xDS 的发现服务可用于通过网络动态配置 Envoy，并为 Envoy 提供有关主机、集群 HTTP 路由、监听套接字和加密的信息。届时，Envoy 会尝试优雅地耗尽所有连接。

### Health checking 健康检查

与负载平衡器相关的一个功能是只将流量路由到健康且可用的上游服务。Envoy 支持健康检查子系统，可对上游服务集群进行主动健康检查。然后，Envoy利用服务发现和健康检查信息的结合来确定健康的负载平衡目标。Envoy 还能通过异常点检测子系统支持被动健康检查。

### Advanced load balancing

Envoy 支持自动retries, circuit breaking, global rate limiting（使用外部速率限制服务）、request shadowing (or 流量镜像)、异常点检测和request hedging.。

+ 自动重试（Automatic Retries）

  假设你有一个订单服务 `order-service`，它调用 `payment-service` 完成支付

  + Envoy 可以配置 **自动重试**，如果请求失败（如 `5xx` 错误），它会在 **指定的时间间隔** 内自动重试 **N 次**，减少失败率。

+ 断路器（Circuit Breaking）

  + **断路器（Circuit Breaker）** 机制，当检测到 `payment-service` 的错误率过高时，**主动熔断请求**，直接返回错误，避免继续占用资源。

+ 全局限流（Global Rate Limiting）

  你运营一个 API 网关，用户可以调用 `login-service` 进行登录，但为了防止 **暴力破解**（攻击者疯狂尝试不同密码），需要限制请求频率。

  + 全局限流（Global Rate Limiting）Envoy 可以**连接外部限流服务**（如 Redis 或 gRPC Rate Limit Service），对用户请求进行**全局速率限制**，如 **每分钟最多 10 次登录尝试**。

+ 请求镜像（Request Shadowing / Traffic Mirroring）

  你要发布一个新版本 `payment-service-v2`，但怕它有 bug，不能直接替换老版本 `payment-service-v1`，希望先**在后台测试流量**，不影响用户体验。

  + Envoy 可以**镜像（shadowing）真实流量**到 `payment-service-v2`，但**不会影响原始请求的正常处理**。

+ 异常实例检测（Outlier Detection）

  你有 `user-service` 运行在 5 台服务器上，但其中一台服务器 **请求失败率很高**，会导致部分用户体验很差。

  + Envoy 自动识别 **失败率高的服务器**，并将其**临时踢出负载均衡池**。

+ 请求投机执行（Request Hedging）

  你运营一个搜索引擎，用户搜索时，可能会被不同的后端服务器处理，但有些服务器**响应特别慢**，影响用户体验。

  + **请求投机执行（Request Hedging）**：如果一个请求延迟过高，Envoy **自动发送另一个相同请求** 到其他服务器，加速响应。

总结：

| 功能             | 解决问题                 | 生产环境中的作用                   |
| ---------------- | ------------------------ | ---------------------------------- |
| **自动重试**     | 处理瞬时故障             | 避免因短暂网络抖动导致请求失败     |
| **断路器**       | 保护系统不被故障级联影响 | 防止雪崩效应，避免服务过载         |
| **全局限流**     | 防止 API 滥用            | 保护系统不被恶意攻击               |
| **请求镜像**     | 线上无风险测试新版本     | 无需影响用户即可验证新服务         |
| **异常实例检测** | 识别失败率高的服务器     | 保障用户访问正常服务器，提高可靠性 |
| **请求投机执行** | 处理慢请求               | 降低响应时间，提升用户体验         |

### Front/edge proxy support

Envoy 具有非常适合作为边缘代理运行的功能。这些功能包括 TLS 终止、HTTP/1.1、HTTP/2 和 HTTP/3 支持以及 HTTP L7 路由。

### TLS termination

应用程序与代理的解耦使得网状部署模式中的所有服务之间都能终止 TLS（相互 TLS）。

### 一流的可观测性

为了便于可观察性，Envoy 会生成日志、度量和跟踪。Envoy 目前支持 [statsd](https://github.com/etsy/statsd)（以及兼容的提供商）作为所有子系统的统计汇。由于具有可扩展性，我们还可以根据需要插入不同的统计数据提供者。

### HTTP/3 (Alpha) 

Envoy 1.19.0 支持 HTTP/3 上下游，可在 HTTP/1.1、HTTP/2 和 HTTP/3 之间进行转换。
